<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receipt</title>
  <style id="pageSize">
    @page { size: 58mm auto; margin: 0; }
    html, body { padding: 0; margin: 0; }
  </style>
  <style>
    :root { --fs: 12px; }
    body { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .wrap { width: 58mm; padding: 6px 6px 24px; box-sizing: border-box; }
    .center { text-align: center; }
    .right { text-align: right; }
    .muted { opacity: .8; }
    hr { border: none; border-top: 1px dashed #000; margin: 6px 0; }
    table { width: 100%; border-collapse: collapse; }
    td { vertical-align: top; font-size: var(--fs); line-height: 1.25; padding: 2px 0; }
    .totals td { font-weight: bold; }
    .small { font-size: 11px; }
    .big { font-size: 14px; font-weight: 700; }

    /* Item table with fixed columns */
    table.items { table-layout: fixed; }
    td.name  { width: 52%; padding-right: 4px; }
    td.price { width: 18%; text-align: right; }
    td.qty   { width: 10%; text-align: right; }
    td.line  { width: 20%; text-align: right; }
  </style>
</head>
<body>
  <div class="wrap" id="paper">
    <div class="center">
      <div class="big" id="outlet">Outlet</div>
      <div class="small muted" id="address"></div>
      <div class="small muted" id="phone"></div>
    </div>
    <hr />
    <table>
      <tr>
        <td>Ticket</td><td class="right" id="ticket">-</td>
      </tr>
      <tr>
        <td>Date</td><td class="right" id="ts">-</td>
      </tr>
      <tr id="customerRow" style="display:none;">
        <td>Customer</td><td class="right" id="customer">-</td>
      </tr>
      <tr id="cashierRow" style="display:none;">
        <td>Cashier</td><td class="right" id="cashier">-</td>
      </tr>
    </table>

    <hr />
    <table class="items" id="itemsTable"></table>
    <hr />

    <table class="totals">
      <tr id="subtotalRow" style="display:none;">
        <td>Subtotal</td><td class="right" id="subtotal">Rp 0</td>
      </tr>
      <tr id="discountRow" style="display:none;">
        <td>Discount</td><td class="right" id="discount">Rp 0</td>
      </tr>
      <tr id="taxRow" style="display:none;">
        <td>Tax</td><td class="right" id="tax">Rp 0</td>
      </tr>
      <tr>
        <td>Total</td><td class="right" id="total">Rp 0</td>
      </tr>
      <tr id="cashRow" style="display:none;">
        <td>Cash</td><td class="right" id="cash">Rp 0</td>
      </tr>
      <tr id="changeRow" style="display:none;">
        <td>Change</td><td class="right" id="change">Rp 0</td>
      </tr>
    </table>

    <hr />
    <div class="center small muted" id="footer">Thank you!</div>
  </div>

  <script>
    // --- Helpers ---
    const qs = new URLSearchParams(location.search);
    const id = (x) => document.getElementById(x);
    const toNum = (x) => Number(String(x ?? '').replace(/[^\d\-]/g, '')) || 0;
    const money = (n, withRp = true) => {
      const num = toNum(n);
      const s = num.toLocaleString('id-ID');
      return withRp ? ('Rp ' + s) : s;
    };
    const show = (rowId, cond) => { const el = id(rowId); if (el) el.style.display = cond ? '' : 'none'; };

    // --- Page size (58mm or 80mm) ---
    const widthParam = (qs.get('w') || '58').trim();
    const width = (widthParam === '80') ? '80mm' : '58mm';
    id('pageSize').innerHTML = `@page { size: ${width} auto; margin: 0; } html, body { padding:0; margin:0; }`;
    const wrap = document.getElementById('paper'); if (wrap) wrap.style.width = width;

    // --- Header ---
    id('outlet').textContent  = qs.get('outlet')  || 'Outlet';
    id('address').textContent = qs.get('addr')    || '';
    id('phone').textContent   = qs.get('tel')     || '';
    id('footer').textContent  = qs.get('footer')  || 'Thank you!';

    // --- Ticket meta ---
    id('ticket').textContent  = qs.get('ticket')  || '-';
    const tsRaw = qs.get('ts');
    const parsed = tsRaw ? new Date(tsRaw) : new Date();
    id('ts').textContent = isNaN(parsed.getTime())
      ? new Date().toLocaleString('id-ID', { hour12: false })
      : parsed.toLocaleString('id-ID', { hour12: false });

    // Support Customer/Name param (case-insensitive key)
    const customerParam = qs.get('customer') || qs.get('Customer') || qs.get('name') || qs.get('Name');
    if (customerParam) { id('customer').textContent = customerParam; show('customerRow', true); }

    const cashier = qs.get('cashier');
    if (cashier) { id('cashier').textContent = cashier; show('cashierRow', true); }

    // --- Items ---
    // EXPECT: name|price|qty|lineTotal;name|price|qty|lineTotal;...
    // If lineTotal is missing, compute price*qty.
    const itemsStr = qs.get('items') || '';
    const rows = itemsStr.split(';').map(s => s.trim()).filter(Boolean);
    const items = rows.map(s => {
      const parts = s.split('|');
      const name  = decodeURIComponent(parts[0] || '');
      const price = toNum(parts[1]);
      const qty   = toNum(parts[2]);
      const total = parts.length > 3 ? toNum(parts[3]) : price * qty;
      return { name, price, qty, total };
    });

    const itemsTable = id('itemsTable');
    let computedSubtotal = 0;
    items.forEach(it => {
      computedSubtotal += it.total;
      const tr = document.createElement('tr');
      const tdName  = document.createElement('td'); tdName.className  = 'name';  tdName.textContent  = it.name;
      const tdPrice = document.createElement('td'); tdPrice.className = 'price'; tdPrice.textContent = money(it.price, false);
      const tdQty   = document.createElement('td'); tdQty.className   = 'qty';   tdQty.textContent   = it.qty;
      const tdLine  = document.createElement('td'); tdLine.className  = 'line';  tdLine.textContent  = money(it.total, false);
      tr.appendChild(tdName); tr.appendChild(tdPrice); tr.appendChild(tdQty); tr.appendChild(tdLine);
      itemsTable.appendChild(tr);
    });

    // --- Totals (allow override via query) ---
    const subtotal = qs.has('subtotal') ? toNum(qs.get('subtotal')) : computedSubtotal;
    const discount = toNum(qs.get('discount'));
    const tax      = toNum(qs.get('tax'));
    // Accept both total and Total
    const totalParam = qs.has('total') ? qs.get('total') : (qs.has('Total') ? qs.get('Total') : null);
    const total    = totalParam != null ? toNum(totalParam) : (subtotal - discount + tax);
    const cash     = qs.has('cash') ? toNum(qs.get('cash')) : null;
    const change   = qs.has('change') ? toNum(qs.get('change')) : (cash != null ? (cash - total) : null);

    if (qs.has('subtotal')) show('subtotalRow', true);
    if (qs.has('discount')) show('discountRow', true);
    if (qs.has('tax'))      show('taxRow', true);
    if (cash != null)       show('cashRow', true);
    if (change != null)     show('changeRow', true);

    id('subtotal').textContent = money(subtotal);
    id('discount').textContent = money(discount);
    id('tax').textContent      = money(tax);
    id('total').textContent    = money(total);
    if (cash != null)   id('cash').textContent   = money(cash);
    if (change != null) id('change').textContent = money(change);

    // --- Auto print & optional auto-close ---
    const doClose = (qs.get('close') === '1');
    window.onload = () => { window.print(); };
    window.onafterprint = () => { if (doClose) window.close(); };
  </script>
</body>
</html>
